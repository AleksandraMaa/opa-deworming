---
title: "Net Present Value (NPV) for Deworming"
date: "13 October, 2019"
output:
  html_document:
    code_folding: hide
    code_download: true
    collapsed: yes
    keep_md: yes
    number_sections: yes
    smooth_scroll: no
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document: default
  word_document: default
editor_options:
  chunk_output_type: console
pdf_document:
  extra_dependencies: ["xcolor"]
---
\def\blue{\color{blue}}
\def\red{\color{red}}






```r
################
#####  Notes:
################
### Source ---------->  Input ---------->  Model ---------->  Policy Estimates (output)
###  (_so)              (_in)              (_mo)                (_pe)
### values            functions          functions              values
###                   & values           & values             
# - call_sources_f- tax_elasticity_in_f  - tax_revenue_mo_f     - ten_year_revenue_pe
# - policy_f      - est_billionares_in_f - total_rev_mo_f       - ten_year_top_tax_pe
#                                        - ten_years_mo_f       - total_rev_pe
### arguments in functions should use "_var" and functions should use "_f"


# DESCRIBE FUNCTIONS STRUCTURE
# - inputs: list
# - outputs: list
#### function:  
#sample_function_f <- function(){
##########################################
##########################################  
#
#
##########################################
##########################################  
#    return( )                                  # A list with all (most?) the elements
#}                                              # generated inside the function
#invisible( list2env(sample_function_f(),.GlobalEnv) )
#
```


```r
library(readxl)

call_params_f <- function(){
    #############
    ##### Data  
    #############
    gov_bonds_so <- 	0.1185	     #Kenyan interest on sovereign debt - Central Bank of Kenya
    inflation_so <-   0.02         #Kenyan inflation rate - World Bank Development Indicators
    coverage_so  <-   0.681333333  #(R) Fraction of treated primary school students within 6 km - from W@W - see note
    tax_so <-         0.16575      #ADD INFO!
    ex_rate_so <- 85               #Exchange Rate - Central Bank of Kenya
    unit_cost_local_so <- 43.66    #Deworm the World
    years_of_treat_so <- 2.41      #Additional Years of Treatment - Table 1, Panel A

    # Add costs data
    #df_costs_so <- read_excel("rawdata/data/DtW Cost per Child Data.xlsx", sheet = "DtW Costs")
    # Add crosswalk data on region and country
    #df_costs_cw_so <- read_excel("rawdata/data/DtW Cost per Child Data.xlsx", sheet = "state_country")

    # Add data on number of treated children
    #df_counts_so <- read_excel("rawdata/data/DtW Cost per Child Data.xlsx", sheet = "DtW Treatment #s")

    #############
    ##### Research
    #############    
    lambda1_so <- c(87, 83, 81)    # Direct treatment effect on earnings. From tables generated by Michelle on 10/4/19
    lambda2_so <- c()              # Spillover treatment effect on earnings. FILL THIS IN
    q_full_so <- 0.75              #Take up rates with full subsidy. From Miguel and Kremmer (2007)
    q_zero_so <- 0                 #Take up rates with zero subsidy. From Miguel and Kremmer (2007)
    delta_ed_so <- c(-0.00176350949079451, 0.00696052250263997, 0.0258570306763183,     # (Delta E) Additional direct seconday schooling increase (from Joan)
                        0.0239963665555466, 0.027301406306074, 0.0234125454594173,
                       0.0279278879439199, 0.00647044449446303, 0.00835739437790601)                                     
    delta_ed_so <- cbind(delta_ed_so, 1999:2007)
    delta_ed_ext_so <- c(-0.0110126908021048,	0.0140448546741008,	-0.0034636291545585,  #Additional externality secondary schooling increase (from Joan)
                           0.0112940214439477,	0.0571608179771775,	-0.0560546793186931,
                           0.0558284756343451,	0.1546264843901160,	0.0055961489945619)
    delta_ed_ext_so <- cbind(delta_ed_ext_so, 1999:2007)  
    #include_ext_so <- TRUE

    #############
    ##### Guess work   
    #############
    periods_so <- 50               #Total number of periods to forecast wages
    index_t <- 0:periods_so
    time_to_jm_so <- 10            #Time from intial period until individual join the labor force
    teach_sal_so <- 5041           #Yearly secondary schooling compensation	5041 - from ROI materials
    teach_ben_so <- 217.47         #Yearly secondary schooling teacher benefits	217.47
    n_students_so <- 45            #Average pupils per teacher	45
    
    return( sapply( ls(pattern= "_so\\b"), function(x) get(x)) )
}
invisible( list2env(call_params_f(),.GlobalEnv) )
```

# Main Equation (the model)

\begin{equation}
NPV = \underbrace{\tau \underbrace{\sum_{t=0}^{50}\Big(\frac{1}{1+r}\Big)^t\Delta Y_{t}}_\text{sum of discounted earnings gains over time} - \underbrace{K \sum_{t=0}^{50}\Big(\frac{1}{1+r}\Big)^t \Delta \bar{E}_{\gamma t}(S1, S2)}_\text{sum of discounted cost of schooling over time}}_\text{net benefit of deworming over time} - \underbrace{(S_2Q(S_2) - S_1Q(S_1))}_\text{cost of deworming meds}
\label{eq:1}
\tag{1}
\end{equation}

NOT SURE IF THIS FUNCTION IS CODED CORRECTLY
  

```r
# add suffix _var to args 
# - inputs: tax_rev_init_mo, top_tax_base_in  
# - outputs: total_rev_pe 
# Gamma is used to index gender.
npv_mo_f <- function(tax_var = tax_so,
                     interest_r_var = interest_in[[1]],
                     delta_earnings_var = delta_earnings_p_in,
                     delta_ed_male_var = delta_ed_so[,1],
                     delta_ed_female_var = delta_ed_so[,1],
                     cost_of_schooling_var = cost_per_student_in,
                     s1_var = 0, q1_var = 0, s2_var = s2_in, q2_var = q2_in) {
  delta_ed_s <- cbind(delta_ed_male_var, delta_ed_female_var) 
############################################################################### 
  benef <- matrix(NA, 51,2)
  for (i in 1:2){
    benef[,i] <- ( 1 / (1 + interest_r_var) )^index_t*delta_earnings_var
  }
  
  res1 <- sum( ns * ( tax_var * apply(benef, 2, sum) - apply( ( 1 / (1 + interest_r_var) )^index_t *
                     delta_ed_s * cost_of_schooling_var, 2, sum) )
          ) - (s2_var * q2_var  - s1_var * q1_var)
  return(res1) 
############################################################################### 
}
```

## Subcomponents

### The real interest rate ($r$)

\begin{equation}
NPV = \tau\sum_{t=0}^{50}\Big(\frac{1}{1+\blue{r}}\Big)^t\Delta Y_{t} - K \sum_{t=0}^{50}\Big(\frac{1}{1+\blue{r}}\Big)^t \Delta \bar{E}_{\gamma t}(S1, S2) - (S_2Q(S_2) - S_1Q(S_1))
\end{equation}

The real interest rate $r$ is obtained from the interest rate on goverment bonds (0.118) minus the inflation rate (0.02).


```r
# - inputs: gov_bonds_so, inflation_so
# - outputs: interest_in
interest_in_f <- function(gov_bonds_var = gov_bonds_so , inflation_var = inflation_so) {
  ############################################################################### 
  interest_in = gov_bonds_var - inflation_var 
  ############################################################################### 
  return(list("interest_in" = interest_in))
}
invisible( list2env(interest_in_f(),.GlobalEnv) )
interest_in <- interest_in_f()
```

### Earnings gains ($\Delta Y_t$)

\begin{equation}
NPV = \tau\sum_{t=0}^{50}\Big(\frac{1}{1+r}\Big)^t\blue{\Delta Y_{t}} - K \sum_{t=0}^{50}\Big(\frac{1}{1+r}\Big)^t \Delta \bar{E}_{\gamma t}(S1, S2) - (S_2Q(S_2) - S_1Q(S_1))
\end{equation}

We start by ignoring spillovers ($\lambda_2$), and look only at direct effects.

The change in earnings ($\Delta Y_t$) is given by a step function so that earnings change discontinuously every 5 years. This is because we estimate treatment effects on total earnings by round. KLPS-2 captures effects after 10 years, KLPS-3 effects after 15 years, and KLPS-4 effects after 20 years. This provides evidence on the time path of earnings up through 20 years. We will need to make assumptions about earnings gains from deworming after 20 years.

ADD EXTERNALITIES TO CODE.

#### Assumption 1 
If we assume that the effect on earnings identified 20 years out persist through one's working life, then the change in earnings is given by:

\begin{equation}
\Delta Y_t = \mathbf{1}(10 < t \leq 15)\lambda_1^{KLPS2} + \mathbf{1}(15 < t \leq 20)\lambda_1^{KLPS3} + \mathbf{1}(t > 20)\lambda_1^{KLPS4}
\end{equation}


```r
# - inputs: periods_so, lambda1_so
# - outputs: 
delta_earnings_p_in_f <- function(t_var = 1:periods_so, 
                             lambda1k1_var = lambda1_so[1], 
                             lambda1k2_var = lambda1_so[2], 
                             lambda1k3_var = lambda1_so[3]) {
############################################################################### 
  delta_earnings_p_in = 1*(10 <= t_var & t_var < 15) * lambda1k1_var + 1*(15 <= t_var & t_var < 20) * lambda1k2_var + 1*(20 <= t_var) * lambda1k3_var
############################################################################### 
  return(list("delta_earnings_p_in" = delta_earnings_p_in))
}
invisible(list2env(delta_earnings_p_in_f(),.GlobalEnv) )
delta_earnings_p_in <- delta_earnings_p_in_f()
```

#### Assumption 2
Instead, if we assume that the effect of earnings persist for 5 years after KLPS-4 (matching the time period between previous rounds), then disappear, then the change in earnings is given by:

\begin{equation}
\Delta Y_t = \mathbf{1}(10 < t \leq 15)\lambda_1^{KLPS2} + \mathbf{1}(15 < t \leq 20)\lambda_1^{KLPS3} \nonumber + \mathbf{1}(20 < t \leq 25 )\lambda_1^{KLPS4} + \underbrace{\mathbf{1}(t > 25 ) \cdot 0}_{\substack{\text{Assume all benefits evaporate} \\ \text{before ``next'' KLPS round}}}
\end{equation}


```r
# - inputs: periods_so, lambda1_so
# - outputs: 
delta_earnings_in_f <- function(t_var = 1:periods_so, 
                                lambda1k1_var = lambda1_so[1], 
                                lambda1k2_var = lambda1_so[2], 
                                lambda1k3_var = lambda1_so[3]) {
############################################################################### 
  delta_earnings_in = 1*(10 <= t_var & t_var < 15) * lambda1k1_var + 1*(15 <= t_var & t_var < 20) * lambda1k2_var + 1*(20 <= t_var & t_var < 25) * lambda1k3_var
############################################################################### 
  return(list("delta_earnings_in" = delta_earnings_in))
}
invisible( list2env(delta_earnings_in_f(),.GlobalEnv) )
delta_earnings_in <- delta_earnings_in_f()
```

Note that both expressions assume no earnings gains for the first 10 years.

### 5 - $K$ and $\Delta \overline{E}_{\gamma t}(S1,S2)$ 

$K$ represents the cost per student. This is calculated as the salary of the teacher plus benefits, divided by the average number of students per teacher.

\begin{equation}
K = \frac{\text{teacher salary} + \text{teacher benefits}}{\text{# Students}}
\end{equation}

For $\Delta \overline{E}_{\gamma t}(S1,S2)$ we use a series of estimated effects the additional direct increase in secondary schooling from 1999 to 2007 obtained from [need to define the source "from Joan" in `Assumps&Panel A Calcs!A93`].

This series does not take into account the externality effects. To incorporate the we need another series (same source) that estimates the additional secondary schooling increase due to the externality and add it to the original series.


```r
include_ext_mo <- TRUE
# - inputs: coverage_so, q_full_so, q_zero_so 
# - outputs: saturation_in 
ed_costs_in_f <- function(teach_sal_var = teach_sal_so, teach_ben_var = teach_ben_so, 
                          n_students_var = n_students_so, delta_ed_ext_var = delta_ed_ext_so,
                          delta_ed_var = delta_ed_so, include_ext_var = include_ext_mo){
###############################################################################    
    cost_per_student_in <- (teach_sal_var + teach_ben_var) / n_students_var
    
    # Nothing here yet with delta_ed_vals, but would like to incorporate model from Joan
    delta_ed_ext_total_in <- delta_ed_ext_var[,1] + delta_ed_var[,1]
    
    if (include_ext_var == TRUE){
      delta_ed_final_in <-  delta_ed_ext_total_in
    }else{
      delta_ed_final_in <- delta_ed_var[,1]
    }
    return(list("cost_per_student_in" = cost_per_student_in, "delta_ed_final_in" = 
                  delta_ed_final_in,  "delta_ed_ext_total_in" = delta_ed_ext_total_in)) 
###############################################################################
} 
invisible( list2env(ed_costs_in_f(),.GlobalEnv) )
```

**Note:** need to understand better the date of each component (of the model, not only this section).

### 6 - $\left( S_{2}Q(S_{2}) - S_{1}Q(S_{1}) \right)$

#### 6.1 - $S_{1}Q(S_{1}) = 0$
There is no subsidy for deworming under the status quo.   


#### 6.2 - $S_{2}$: complete subsidy to per capita costs of deworming.

With complete subsidy, $S_2$ represents the total direct costs of deworming in USD. Calculated as follows

\begin{equation}
S_{2} = \frac{\text{Cost per person per year (KSH)}	}{ex}\times \text{Additional years of treatment} \\
\end{equation}

#### 6.3 - $Q_{2}$
The take-up with full subsidy ($Q_2$) comes from a previous study (Miguel and Kremer 2007) and takes the value of 0.75.

EDIT FROM HERE.


```r
# - inputs: 
# - outputs: 
costs_f <- function(unit_cost_local_var = unit_cost_local_so, ex_rate_var = ex_rate_so,
                    years_of_treat_var = years_of_treat_so, q_full_var = q_full_so){
###############################################################################
    s2_in <- ( unit_cost_local_var / ex_rate_var ) * years_of_treat_var
    q2_in <- q_full_var
    return(list("s2_in" = s2_in, "q2_in" = q2_in)) 
###############################################################################
} 
invisible( list2env(costs_f(),.GlobalEnv) )
```

## NPV by cases

## Tax on NPV by cases

## Tax on NPV by cases

| case | r | persistence | NPV           | tax on NPV | IRR|
|------|---|-------------|---------------|------------|----|
| 1    |   |             | 0             |            |    |
| 2    |   |             |               | 0          |    |
| 3    |   |             |               |            |10% |
| 4    |10%| 40 years    |               |            |    |
| 5    |10%| 25 years    |               |            |    |
| 6    |5% | 40 years    |               |            |    |
