---
title: "Dynamic Document for Fiscal Impacts of Deworming"
output:
  html_document:
    code_folding: hide
editor_options: 
  chunk_output_type: console
---
\def\blue{\color{blue}}


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, eval=FALSE}
#starting point is
# Calcs-Table 5!N21 =
# 'Assumps&Panel A Calcs'!$B$135 * 'Assumps&Panel A Calcs'!$B$10 * 
# 'Model Params&Exp Profiles'!R9 * 'Model Params&Exp Profiles'!R8
```


```{r paramters}
## Data 
gov_bonds <- 	0.1185	      #Kenyan interest on sovereign debt - Central Bank of Kenya
inflation <-  0.02          #Kenyan inflation rate - World Bank Development Indicators
wage_ag_val <- 	11.84	      #Mean hourly wage rate (KSH) - Suri 2011 
wage_ww_val <- 	14.5850933  #Control group hourly wage, ww (cond >=10 hrs per week) - Table 4, Panel B
profits_se_val <- 1766      #Control group monthly self-employed profits - Table 4, Panel A
hours_se_cond_val <- 38.1   #Control group weekly self-employed hours, conditional on hrs >0 - Table D13, Panel D
hours_ag_val <- 8.3         #Control group hrs per week, agriculture - Table 4, Panel D
hours_ww_val <- 6.9         #Control group hrs per week, working for wages - Table 4, Panel B
hours_se_val <- 3.3         #Control group hrs per week, self-employment - Table 4, Panel A
ex_rate_val <- 85           #Exchange Rate - Central Bank of Kenya 
growth_rate_val <- 1.52/100 #Per-capita GDP growth, 2002-2011 (accessed 1/29/13) -	World Bank - see notes
coverage_val  <- 0.681333333#Fraction of treated primary school students within 6 km - from W@W - see note
saturation_val <-  0.511    #Overall Saturation - not reported in table, average of T & C
full_saturation_val <- 0.75
tax_val <- 0.16575          #ADD INFO
unit_cost_local_val <- 43.66#Deworm the World
years_of_treat_val <- 2.41  #Additional Years of Treatment - Table 1, Panel A


## Research
lambda1_vals <- c(3.49, 0) #Hrs per week increase for men and women CONFIRM
lambda2_val <- 10.2         #Externality effect (proportional) - Table 3, Panel B
q_full_val <- 0.75          #Take up rates with full subsidy. From Miguel and Kremmer (2007)

## Guess work
periods_val <- 50           #Total number of periods to forecast wages
time_to_jm_val <- 10        #Time from intial period until individual join the labor force
coef_exp_val <- c(0, 0)     #Years of experience coefficients (1-linear, 2-cuadratic)	- see notes 
teach_sal_val <- 5041       #Yearly secondary schooling compensation	5041 - from ROI materials
teach_ben_val <- 217.47     #Yearly secondary schooling teacher benefits	217.47
n_students_val <- 45        #Average pupils per teacher	45



# (Delta E) Additional direct seconday schooling increase (from Joan)	
delta_ed_vals <- c(-0.00176350949079451, 0.00696052250263997, 0.0258570306763183, 
  0.0239963665555466, 0.027301406306074, 0.0234125454594173, 0.0279278879439199, 
  0.00647044449446303, 0.00835739437790601)                                     

delta_ed_vals <- cbind(delta_ed_vals, 1999:2007)


-0.011012691	0.014044855	-0.003463629	0.011294021	0.057160818	-0.056054679	0.055828476	0.154626484	0.005596149
-0.011012691	0.014044855	-0.003463629	0.011294021	0.057160818	-0.056054679	0.055828476	0.154626484	0.005596149
-0.011012691	0.014044855	-0.003463629	0.011294021	0.057160818	-0.056054679	0.055828476	0.154626484	0.005596149


#Notes: 
# on growth_rate_val: (http://data.worldbank.org/indicator/NY.GDP.PCAP.KD/), see calculation on "Kenya GDP per capita" tab. In W@W this equals 1.52%. ISSUE: This growth number should be updated to be 2002-2014, I think.
# on coef_exp_val: 1998/1999 Kenyan labor force survey; regression of earnings on age, age^2, female dummy, indicators for attained primary/secondary/beyond, and province dummies. Estimate used in W@W: (0.1019575, -0.0010413). ISSUE: For now assume no further life cycle adjustment beyond KLPS-3 (likely a conservative assumption).
# coverage_val: Overall Saturation (0.511) / 0.75 - not reported in table, average of T & C
```

    

## Who are the policy makers?
 - Ministries of Health, Education and Finance. 

## What is the relevant output that should be used to inform them?
 - NPV
 
## Proposed output:    
 
```{r sample-output, echo=FALSE, warning=FALSE, message=FALSE}
set.seed(1234) 
library(tidyverse)

ggplot() +
  geom_density(aes(x = rnorm(1000, mean = 1),
                   alpha = 1/2), bw=.11, kernel = "gau") +
  geom_vline(xintercept = c(0, 1), col="blue") +
  coord_cartesian(xlim = c(-3,3)) +
  scale_x_discrete(limits = c(0,1))  +   
  guides(alpha = "none", colour="none") +
  labs(y = NULL,
       x = "NPV" ,
       title = "PROPOSED OUTPUT [NOT REAL DATA]:", 
       subtitle = "Distribution NPV of Fiscal Impacts of Deworming")+
  theme(axis.ticks = element_blank(), axis.text.y = element_blank())
```
 
## Main Equation (the model)

\begin{equation}
NPV =  \sum_{\gamma} N_{\gamma} \left[ 
\tau \sum_{t=0}^{50} \left( \frac{1}{1 + r}\right)^{t} w_{t} 
\left( \lambda_{1, \gamma} + \frac{p \lambda_{2, \gamma}}{R} \right) - 
K \sum_{t=0}^{50} \left( \frac{1}{1 + r}\right)^{t} \Delta \overline{E}_{\gamma t}(S1,S2)
\right] - \left( S_{2}Q(S_{2}) - S_{1}Q(S_{1}) \right)
\label{eq:1}
\tag{1}
\end{equation}


```{r model}
# Gamma is used to index gender. 
npv <- function(n_male=1/2, n_female=1/2, 
                interest_r=interst_r_val, 
                wage=wage_t_val, 
                lambda1_male=lambda1_vals[1],
                lambda1_female=lambda1_vals[2], 
                tax=tax_val, 
                saturation=saturation_val, 
                coverage=coverage_val, 
                cost_of_schooling=cost_per_student, 
                delta_ed_male=delta_ed_vals[,1], 
                delta_ed_female=delta_ed_vals[,1], 
                lambda2_male=lambda2s_vals[1], 
                lambda2_female=lambda2s_vals[2], 
                s1=0, q1=0, s2=s2_val, q2=q2_val, 
                periods=periods_val) {
  ns <- c(n_male, n_female)
  lambda1s <- c(lambda1_male, lambda1_female)
  lambda2s <- c(lambda2_male, lambda2_female)
  index_t <- 0:periods
  delta_ed_s <- cbind(delta_ed_male, delta_ed_female) 
  delta_ed_s <- rbind(c(0,0), delta_ed_s, matrix(0,41, 2) ) 
  
  benef <- matrix(NA, 51,2)
  for (i in 1:2){
  benef[,i] <- ( 1 / (1 + interest_r) )^index_t * wage * 
                     ( lambda1s[i] + saturation * lambda2s[i] / coverage ) 
  }
  
  res1 <- sum( ns * ( tax * apply(benef, 2, sum) - 
            apply( ( 1 / (1 + interest_r) )^index_t * 
                     delta_ed_s * cost_of_schooling, 2, sum)
          )
          ) - (s2 * q2  - s1 * q1) 
  return(res1)  
}
```


## Sub components: 

### "$r$"

\begin{equation}
NPV =  \sum_{\gamma} N_{\gamma} \left[ 
\tau \sum_{t=0}^{50} \blue{\left(  \frac{1}{1 + r}\right)}^{t} w_{t} 
\left( \lambda_{1, \gamma} + \frac{p \lambda_{2, \gamma}}{R} \right) - 
K \sum_{t=0}^{50} \blue{\left( \frac{1}{1 + r}\right)}^{t} \Delta \overline{E}_{\gamma t}(S1,S2)
\right] - \left( S_{2}Q(S_{2}) - S_{1}Q(S_{1}) \right)
\end{equation}

The real interest rate $r$ is obtained from the interest rate on goberment bonds (`r round(gov_bonds, 3)`) minus the inflation rate (`r inflation`). 

```{r real-int-rate}
interst_r_val <- gov_bonds - inflation
```


### "$w_{t}$"

\begin{equation}
NPV =  \sum_{\gamma} N_{\gamma} \left[ 
\tau \sum_{t=0}^{50}\left(  \frac{1}{1 + r}\right)^{t} \blue{ w_{t} }
\left( \lambda_{1, \gamma} + \frac{p \lambda_{2, \gamma}}{R} \right) - 
K \sum_{t=0}^{50} \left( \frac{1}{1 + r}\right)^{t} \Delta \overline{E}_{\gamma t}(S1,S2)
\right] - \left( S_{2}Q(S_{2}) - S_{1}Q(S_{1}) \right)
\end{equation}


\begin{equation}
w_t =  \text{#weeks} \times w_0 (1 + g)^{Xp}(1 + \hat{\beta_1} Xp + \hat{\beta_2} Xp^2) \quad \text{for } t=10, \dots, 50
\end{equation}

ndividual in the data are assumed to enter the labor force 10 years after the (data) present day ($w_t = 0$ for $t<10$). Wage at time $t$ is the weekely starting wage in USD ($w_0$) that has a base growth rate equal to the per capita GDP growth ($g$) applied to however many years of work ($Xp$). In addition to this growth, the salaries are adjusted to represent a (concave) wage life cycle profile ($1 + \hat{\beta_1} Xp + \hat{\beta_2} Xp^2$). 

#### "$w_0$"

\begin{equation}
w_t =  \text{#weeks} \times \blue{w_0} (1 + g)^{Xp}(1 + \hat{\beta_1} Xp + \hat{\beta_2} Xp^2)
\end{equation}

\begin{equation}
w_0 = \frac{1}{ex} \sum_{l \in \{ag, ww, se\}}w_{l}\alpha_{l} \\ \quad \text{with: } \alpha_{l}= \frac{ h_{l}}{h_{ag} + h_{ww} + h_{se}}  
\end{equation}

The initial wage in dollars ($w_{0}$) is a weighted average of wages for control group in agriculture, working wage, and self-employed sectors ($ag, ww, se$). The weights correspond to the average number of hours in each sector ($h_l$) relative to the sum of the average number of hours in each sector. 

The wage in agriculture comes from research (Suri, 2011), the working wage comes from the data and its defined as  hourly wage for the control group for those who reported more than 10 hrs of work per week. The self-employed wage ($w_{se}$) was constructed as follows: 

\begin{equation}
w_{se} =  \frac{ \text{Monthly self-employed profits} }{4.5 \times E[h_{se}|h_{se}>0] }
\end{equation}

Where both parameters (Monthly self-employed profits and self-employed hours for the control group, conditional on hrs >0 - $E[h_{se}|h_{se}>0]$ -) come from the data (ww paper).  

 - **Question**: hrs ag = Assumps&Panel A Calcs B25 - still not sure how it came from table 4 (no panel D and )  
 
 - **Question**: explain diff betwee $E[h_{se}|h_{se}>0]$ and $h_{se}$ (why used differently)    
 

```{r wage_t}
wage_0_f <- function(wage_ag = wage_ag_val, 
                     wage_ww = wage_ww_val, 
                     profits_se = profits_se_val, 
                     hours_se_cond = hours_se_cond_val, 
                     hours_ag = hours_ag_val, 
                     hours_ww = hours_ww_val, 
                     hours_se = hours_se_val, 
                     ex_rate = ex_rate_val) {
  wage_se <- profits_se / (4.5 * hours_se_cond)
  wage_ls <- c(wage_ag, wage_ww, wage_se)
  alpha_ls <- c(hours_ag, hours_ww, hours_se) / sum( c(hours_ag, hours_ww, hours_se) )
  res1 <- 1/ex_rate * sum( wage_ls * alpha_ls )
  return(res1)
}

#close to value from spreadsheet (Assumps&Panel A Calcs!B137 = 0.1481084), 
#but I suspect diff due to computational precision 

wage_0_val <- wage_0_f()  

experience_val <- 0:periods_val - time_to_jm_val

wage_t <- function(wage_0 = wage_0_val, 
                   growth_rate = growth_rate_val, 
                   experience = experience_val, 
                   coef_exp1 = coef_exp_val[1], 
                   coef_exp2 = coef_exp_val[2]) {
  res1 <- 52 * wage_0 *( ( 1 + growth_rate )^experience ) * 
    ( 1 + coef_exp1 * experience + coef_exp2 * experience^2 ) * 
    ifelse(0:periods_val >= time_to_jm_val, 1, 0)
  return(res1) 
}

#close to value from spreadsheet (Calcs-Table 5!N21.. = 7.701634678), 
#but I suspect diff due to computational precision 
wage_t_val <- wage_t()
```


### "$\lambda_{1,\gamma}$"  and  "$\lambda_{2,\gamma}$"

\begin{equation}
NPV =  \sum_{\gamma} N_{\gamma} \left[ 
\tau \sum_{t=0}^{50}\left(  \frac{1}{1 + r}\right)^{t} w_{t} 
\left(\blue{ \lambda_{1, \gamma} } + \frac{p \blue{\lambda_{2, \gamma}}}{R} \right) - 
K \sum_{t=0}^{50} \left( \frac{1}{1 + r}\right)^{t} \Delta \overline{E}_{\gamma t}(S1,S2)
\right] - \left( S_{2}Q(S_{2}) - S_{1}Q(S_{1}) \right)
\end{equation}

$\lambda_{1,\gamma}$ represents the estimated impact of deworming on hours of work for men a womam. This two parameter are combined with a unwweighted mean: 

\begin{equation}
\lambda_{1} = \frac{1}{2} \lambda_{1,male} + \frac{1}{2} \lambda_{1,female} 
\end{equation}
Its components come research (W\@W). 

$\lambda_{2,\gamma}$ the estimated externality effect (EXPLAIN) and comes research (W\@W). Note that this parameter in not estimated by gender, so we repeat its value two times. 

```{r lambdas}
lambda1_vals <- rep(0.5 * lambda1_vals[1] + 0.5 *lambda1_vals[2], 2)
lambda2s_vals <- rep(lambda2_val, 2)
```


### $R$ and $p$  

\begin{equation}
NPV =  \sum_{\gamma} N_{\gamma} \left[ 
\tau \sum_{t=0}^{50}\left(  \frac{1}{1 + r}\right)^{t} w_{t} 
\left( \lambda_{1, \gamma}  + \frac{\blue{p} \lambda_{2, \gamma}}{\blue{R}} \right) - 
K \sum_{t=0}^{50} \left( \frac{1}{1 + r}\right)^{t} \Delta \overline{E}_{\gamma t}(S1,S2)
\right] - \left( S_{2}Q(S_{2}) - S_{1}Q(S_{1}) \right)
\end{equation}



$R$ is the fraction of treated primary school students within 6 km. Computed as 
\begin{equation}
R = \frac{\text{Overall Saturation}  }{Q(full)}
\end{equation}

$p$ is the saturation of the intervention, defined as: 

\begin{equation}
p = Q(full) \times R
\end{equation}

**Note:** there is a circularity on how parameters are defined here. Everything depends on Full Saturation ($Q(full)$) at the end of the day.

```{r coverage-and-saturation}
#R
coverage_val <-  saturation_val / full_saturation_val
#p
saturation_val <- full_saturation_val * coverage_val
```

### $K$ and $\Delta \overline{E}_{\gamma t}(S1,S2)$

\begin{equation}
NPV =  \sum_{\gamma} N_{\gamma} \left[ 
\tau \sum_{t=0}^{50}\left(  \frac{1}{1 + r}\right)^{t} w_{t} 
\left( \lambda_{1, \gamma}  + \frac{p \lambda_{2, \gamma}}{R} \right) - 
\blue{K} \sum_{t=0}^{50} \left( \frac{1}{1 + r}\right)^{t} \blue{ \Delta \overline{E}_{\gamma t}(S1,S2) }
\right] - \left( S_{2}Q(S_{2}) - S_{1}Q(S_{1}) \right)
\end{equation}

$K$ represents the cost per student. This is calculated as the salary of the teacher plus benefits, divided by the average number of students per teacher. 
 
\begin{equation}
K = \frac{\text{teacher salary} + \text{teacher benefits}}{\text{# Students}}
\end{equation}

```{r cost-per-student}
cost_per_student <- (teach_sal_val + teach_ben_val) / n_students_val
```

This is the $\overline{E}_{\gamma t}(S1,S2)$   

**Note:** need to understand better the date of each component (of the model, not only this section). 

```{r delta-ed}
# Nothing here yet, but would like to incorporate model from Joan
delta_ed_vals <- delta_ed_vals
```

### $\left( S_{2}Q(S_{2}) - S_{1}Q(S_{1}) \right)$

\begin{equation}
NPV =  \sum_{\gamma} N_{\gamma} \left[ 
\tau \sum_{t=0}^{50}\left(  \frac{1}{1 + r}\right)^{t} w_{t} 
\left( \lambda_{1, \gamma}  + \frac{p \lambda_{2, \gamma}}{R} \right) - 
K \sum_{t=0}^{50} \left( \frac{1}{1 + r}\right)^{t} \Delta \overline{E}_{\gamma t}(S1,S2)
\right] - \blue{ \left( S_{2}Q(S_{2}) - S_{1}Q(S_{1}) \right) }
\end{equation}

#### $S_{1}Q(S_{1}) = 0$
There is no subsidy for deworming under the status quo.   


#### $S_{2}$

- `Calcs-Table 5!D46` = `=-'Model Params&Exp Profiles'!$B$9 * 'Model Params&Exp Profiles'!$B$14 / (1+$B46) ^ D$44`  

- `'Model Params&Exp Profiles'!$B$9`  
    - Total direct cost of deworming = Cost per person per year (USD) * Additional Years of Treatment  
    - Cost per person per year (USD) = Deworming Cost per person per year (KSH)		 / Exchange Rate

#### $Q_{2}$


- `'Model Params&Exp Profiles'!$B$14`  
    - Q(S_F)
Take-up rate, full subsidy	0.75	Miguel and Kremer (2007)	

```{r costs}
#s2_val <- (Deworming Cost per person per year (KSH) / Exchange Rate) * Additional Years of Treatment  
q2_val <- q_full_val
s2_val <- ( unit_cost_local_val / ex_rate_val ) * years_of_treat_val
```


## Additinal documentation

## Questions (for Michael, Ted or Grace)

- where are the $N_\lambda$ in the spreadsheet?
- To me: should I add small output after each subsection?
- What are the terms behind the calculation of $R$?
- Clarify circularity behing $R$ and $p$
- Why $\Delta \overline{E}_{\gamma t}(S1,S2)$ is not used for separate groups (men and female)

## Next steps:   
- set up each primitive parama as normal(value,sd = something). 
- run 1000? 10000? times and obtain figure 1. 