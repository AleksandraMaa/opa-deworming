---
title: "Dynamic Document for Fiscal Impacts of Deworming"
output:
  html_document:
    code_folding: hide
  word_document: default
  pdf_document: default
editor_options:
  chunk_output_type: console
---
\def\blue{\color{blue}}


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r parameters}

#############
##### Data  
#############
gov_bonds_val <- 	0.1185	      #Kenyan interest on sovereign debt - Central Bank of Kenya
inflation_val <-  0.02          #Kenyan inflation rate - World Bank Development Indicators
wage_ag_val <- 	11.84	          #Mean hourly wage rate (KSH) - Suri 2011
wage_ww_val <- 	14.5850933      #Control group hourly wage, ww (cond >=10 hrs per week) - Table 4, Panel B
profits_se_val <- 1766          #Control group monthly self-employed profits - Table 4, Panel A  FIX: MOST REFERENCES FROM TABLE 4 ARE TABLE 3
hours_se_cond_val <- 38.1       #Control group weekly self-employed hours, conditional on hrs >0 - Table D13, Panel D
hours_ag_val <- 8.3             #Control group hrs per week, agriculture - Table 4, Panel D
hours_ww_val <- 6.9             #Control group hrs per week, working for wages - Table 4, Panel B
hours_se_val <- 3.3             #Control group hrs per week, self-employment - Table 4, Panel A
ex_rate_val <- 85               #Exchange Rate - Central Bank of Kenya
growth_rate_val <- 1.52/100     #Per-capita GDP growth, 2002-2011 (accessed 1/29/13) -	World Bank - see notes
coverage_val  <- 0.681333333    # (R) Fraction of treated primary school students within 6 km - from W@W - see note
tax_val <- 0.16575              #ADD INFO
unit_cost_local_val <- 43.66    #Deworm the World
years_of_treat_val <- 2.41      #Additional Years of Treatment - Table 1, Panel A
#############
##### Research
#############    
lambda1_vals <- c(3.49, 0)      #Hrs per week increase for men and women CONFIRM
lambda2_val <- 10.2             #Externality effect (proportional) - Table 3, Panel B
q_full_val <- 0.75              #Take up rates with full subsidy. From Miguel and Kremmer (2007)
q_zero_val <- 0                 #Take up rates with zero subsidy. From Miguel and Kremmer (2007)
delta_ed_vals <- c(-0.00176350949079451, 0.00696052250263997, 0.0258570306763183,     # (Delta E) Additional direct seconday schooling increase (from Joan)
                    0.0239963665555466, 0.027301406306074, 0.0234125454594173,
                   0.0279278879439199, 0.00647044449446303, 0.00835739437790601)                                     
delta_ed_vals <- cbind(delta_ed_vals, 1999:2007)
delta_ed_ext_vals <- c(-0.0110126908021048,	0.0140448546741008,	-0.0034636291545585,  #Additional externality secondary schooling increase (from Joan)
                       0.0112940214439477,	0.0571608179771775,	-0.0560546793186931,
                       0.0558284756343451,	0.1546264843901160,	0.0055961489945619)
delta_ed_ext_vals <- cbind(delta_ed_ext_vals, 1999:2007)    
#############
##### Guess work   
#############
periods_val <- 50               #Total number of periods to forecast wages
time_to_jm_val <- 10            #Time from intial period until individual join the labor force
coef_exp_vals <- c(0, 0)         #Years of experience coefficients (1-linear, 2-cuadratic)	- see notes
teach_sal_val <- 5041           #Yearly secondary schooling compensation	5041 - from ROI materials
teach_ben_val <- 217.47         #Yearly secondary schooling teacher benefits	217.47
n_students_val <- 45            #Average pupils per teacher	45


#############
##### Notes:
#############
# on growth_rate_val: (http://data.worldbank.org/indicator/NY.GDP.PCAP.KD/), see calculation on "Kenya GDP per capita" tab. In W@W this equals 1.52%. ISSUE: This growth number should be updated to be 2002-2014, I think.
# on coef_exp_val: 1998/1999 Kenyan labor force survey; regression of earnings on age, age^2, female dummy, indicators for attained primary/secondary/beyond, and province dummies. Estimate used in W@W: (0.1019575, -0.0010413). ISSUE: For now assume no further life cycle adjustment beyond KLPS-3 (likely a conservative assumption).
# coverage_val: Overall Saturation (0.511) / 0.75 - not reported in table, average of T & C
```


# Key policy estimates for policy makers  

```{r final-output}

```

# Methodology

## Main Equation (the model)

\begin{equation}
NPV =  \sum_{\gamma} N_{\gamma} \left[
\tau \sum_{t=0}^{50} \left( \frac{1}{1 + r}\right)^{t} w_{t}
\left( \lambda_{1, \gamma} + \frac{p \lambda_{2, \gamma}}{R} \right) -
K \sum_{t=0}^{50} \left( \frac{1}{1 + r}\right)^{t} \Delta \overline{E}_{\gamma t}(S1,S2)
\right] - \left( S_{2}Q(S_{2}) - S_{1}Q(S_{1}) \right)
\label{eq:1}
\tag{1}
\end{equation}

```{r model}
# Gamma is used to index gender.
npv <- function(n_male=1/2, n_female=1/2,
                interest_r=interst_r_val,
                wage=wage_t_val,
                lambda1_male=lambda1_vals[1],
                lambda1_female=lambda1_vals[2],
                tax=tax_val,
                saturation=saturation_val,             
                coverage=coverage_val,
                cost_of_schooling=cost_per_student,
                delta_ed_male=delta_ed_vals[,1],
                delta_ed_female=delta_ed_vals[,1],
                lambda2_male=lambda2_vals[1],
                lambda2_female=lambda2_vals[2],
                s1=0, q1=0, s2=s2_val, q2=q2_val,
                periods=periods_val) {
  ns <- c(n_male, n_female)
  lambda1s <- c(lambda1_male, lambda1_female)
  lambda2s <- c(lambda2_male, lambda2_female)
  index_t <- 0:periods
  delta_ed_s <- cbind(delta_ed_male, delta_ed_female)
  delta_ed_s <- rbind(c(0,0), delta_ed_s, matrix(0,41, 2) )

  benef <- matrix(NA, 51,2)
  for (i in 1:2){
  benef[,i] <- ( 1 / (1 + interest_r) )^index_t * wage *
                     ( lambda1s[i] + saturation * lambda2s[i] / coverage )
  }

  res1 <- sum( ns * ( tax * apply(benef, 2, sum) -
            apply( ( 1 / (1 + interest_r) )^index_t *
                     delta_ed_s * cost_of_schooling, 2, sum) )
          ) - (s2 * q2  - s1 * q1)
#  browser()
  return(res1)  
}
```


## Sub components:

### 1 - "$r$"  

The real interest rate $r$ is obtained from the interest rate on betterment bonds (`r round(gov_bonds_val, 3)`) minus the inflation rate (`r inflation_val`).

```{r comp1}
interest_var_comp <- function(gov_bonds_var , inflation_var) { gov_bonds_var - inflation_var }
interest_val <- interest_var_comp(gov_bonds_var = gov_bonds_val, inflation_var = inflation_val)
```

The resulting value is a $r$ = `r paste(round(100*interest_val,2), "%", sep="")`


### 2 - "$w_{t}$"

\begin{equation}
NPV =  \sum_{\gamma} N_{\gamma} \left[
\tau \sum_{t=0}^{50}\left(  \frac{1}{1 + r}\right)^{t} \blue{ w_{t} }
\left( \lambda_{1, \gamma} + \frac{p \lambda_{2, \gamma}}{R} \right) -
K \sum_{t=0}^{50} \left( \frac{1}{1 + r}\right)^{t} \Delta \overline{E}_{\gamma t}(S1,S2)
\right] - \left( S_{2}Q(S_{2}) - S_{1}Q(S_{1}) \right)
\end{equation}


\begin{equation}
w_t =  \text{#weeks} \times w_0 (1 + g)^{Xp}(1 + \hat{\beta_1} Xp + \hat{\beta_2} Xp^2) \quad \text{for } t=10, \dots, 50
\end{equation}

individual in the data are assumed to enter the labor force 10 years after the (data) present day ($w_t = 0$ for $t<10$). Wage at time $t$ is the weekly starting wage in USD ($w_0$) that has a base growth rate equal to the per capita GDP growth ($g$) applied to however many years of work ($Xp$). In addition to this growth, the salaries are adjusted to represent a (concave) wage life cycle profile ($1 + \hat{\beta_1} Xp + \hat{\beta_2} Xp^2$).

#### 2.1 - "$w_0$"

\begin{equation}
w_t =  \text{#weeks} \times \blue{w_0} (1 + g)^{Xp}(1 + \hat{\beta_1} Xp + \hat{\beta_2} Xp^2)
\end{equation}

\begin{equation}
w_0 = \frac{1}{ex} \sum_{l \in \{ag, ww, se\}}w_{l}\alpha_{l} \\ \quad \text{with: } \alpha_{l}= \frac{ h_{l}}{h_{ag} + h_{ww} + h_{se}}  
\end{equation}

The initial wage in dollars ($w_{0}$) is a weighted average of wages for control group in agriculture, working wage, and self-employed sectors ($ag, ww, se$). The weights correspond to the average number of hours in each sector ($h_l$) relative to the sum of the average number of hours in each sector.

The wage in agriculture comes from research (Suri, 2011), the working wage comes from the data and its defined as  hourly wage for the control group for those who reported more than 10 hrs of work per week. The self-employed wage ($w_{se}$) was constructed as follows:

\begin{equation}
w_{se} =  \frac{ \text{Monthly self-employed profits} }{4.5 \times E[h_{se}|h_{se}>0] }
\end{equation}

Where both parameters (Monthly self-employed profits and self-employed hours for the control group, conditional on hrs >0 - $E[h_{se}|h_{se}>0]$ -) come from the data (ww paper).  The measure of hours in self employment used to compute wages is ($E[h_{se}|h_{se}>0]$) is different from the one is to compute the weights $\alpha_l$ above. The first one captures hours of work among those actively employed in the self-employed sector, and the second one captures the average hours of work in self-employed among all the population of workin age in the sample (hence capturing the relative inportance of the self employed sector in the economy)


# Main results
```{r main-results}
#LOAD FIGURE
```


# Montecarlo simulations  
```{r}







# run the model 
#  input: Input vectors for NPV function
#  output: one vector of NPVs (of lenght Nsims)
# Repeat Nsims times
#  input: all functions from above + NSims
#  output: vector of Results of length NSims



#  generate 1 draw of primitive values:
#  inputs: K primitive means and K standard deviations
#  output: K values with one from simulations
one_draw <- function(gov_bonds_var = gov_bonds_val,gov_bonds_sd_var      = 0.1 * gov_bonds_val,         # Data
    inflation_var       = inflation_val      , inflation_sd_var       = 0.1 * inflation_val,      
    wage_ag_var         = wage_ag_val        , wage_ag_sd_var         = 0.1 * wage_ag_val,        
    wage_ww_var         = wage_ww_val        , wage_ww_sd_var         = 0.1 * wage_ww_val,        
    profits_se_var      = profits_se_val     , profits_se_sd_var      = 0.1 * profits_se_val,     
    hours_se_cond_var   = hours_se_cond_val  , hours_se_cond_sd_var   = 0.1 * hours_se_cond_val,  
    hours_ag_var        = hours_ag_val       , hours_ag_sd_var        = 0.1 * hours_ag_val,       
    hours_ww_var        = hours_ww_val       , hours_ww_sd_var        = 0.1 * hours_ww_val,       
    hours_se_var        = hours_se_val       , hours_se_sd_var        = 0.1 * hours_se_val,       
    ex_rate_var         = ex_rate_val        , ex_rate_sd_var         = 0.1 * ex_rate_val,        
    growth_rate_var     = growth_rate_val    , growth_rate_sd_var     = 0.1 * growth_rate_val,    
    coverage_var        = coverage_val       , coverage_sd_var        = 0.1 * coverage_val,       
    tax_var             = tax_val            , tax_sd_var             = 0.1 * tax_val,            
    unit_cost_local_var = unit_cost_local_val, unit_cost_local_sd_var = 0.1 * unit_cost_local_val,
    years_of_treat_var  = years_of_treat_val , years_of_treat_sd_var  = 0.1 * years_of_treat_val,   
    lambda1_var         = lambda1_vals       , lambda1_sd_var         = c(0.17, 0.17),                # Research     
    lambda2_var         = lambda2_val        , lambda2_sd_var         = 0.1 * lambda2_val,        
    q_full_var          = q_full_val         , q_full_sd_var          = 0.1 * q_full_val,         
    q_zero_var          = q_zero_val         , q_zero_sd_var          = 0.1 * q_zero_val,         
    delta_ed_var        = 1                  , delta_ed_sd_var        = 1 ,       
    delta_ed_ext_var    = 1                  , delta_ed_ext_sd_var    = 1 ,      
    periods_var         = periods_val        , periods_sd_var         = 0.1 * periods_val,            # Guesswork
    time_to_jm_var      = time_to_jm_val     , time_to_sd_var         = 0.1 * time_to_jm_val,      
    coef_exp_var        = coef_exp_vals      , coef_exp_sd_var        = c(0.001 , 0.001),       
    teach_sal_var       = teach_sal_val      , teach_sal_sd_var       = 0.1 * teach_sal_val,       
    teach_ben_var       = teach_ben_val      , teach_ben_sd_var       = 0.1 * teach_ben_val,       
    n_students_var      = n_students_val     , n_students_sd_var      = 0.1 * n_students_val){
    
    rm(list = ls(pattern= "_in") )
    #############
    ##### Data  
    #############
    gov_bonds_in <-           rnorm(1, gov_bonds_var      , gov_bonds_sd_var      )
    inflation_in <-           rnorm(1, inflation_var      , inflation_sd_var      )
    wage_ag_in <-             rnorm(1, wage_ag_var        , wage_ag_sd_var        )
    wage_ww_in <-             rnorm(1, wage_ww_var        , wage_ww_sd_var        )
    profits_se_in <-          rnorm(1, profits_se_var     , profits_se_sd_var     )
    hours_se_cond_in <-       rnorm(1, hours_se_cond_var  , hours_se_cond_sd_var  )
    hours_ag_in <-            rnorm(1, hours_ag_var       , hours_ag_sd_var       )
    hours_ww_in <-            rnorm(1, hours_ww_var       , hours_ww_sd_var       )
    hours_se_in <-            rnorm(1, hours_se_var       , hours_se_sd_var       )
    ex_rate_in <-             rnorm(1, ex_rate_var        , ex_rate_sd_var        )
    growth_rate_in <-         rnorm(1, growth_rate_var    , growth_rate_sd_var    )
    coverage_in  <-           rnorm(1, coverage_var       , coverage_sd_var       )
    tax_in <-                 rnorm(1, tax_var            , tax_sd_var            )
    unit_cost_local_in <-     rnorm(1, unit_cost_local_var, unit_cost_local_sd_var)
    years_of_treat_in <-      rnorm(1, years_of_treat_var , years_of_treat_sd_var )
    #############    
    ##### Research 
    #############     
    lambda1_in <-             rnorm(2, lambda1_var       , lambda1_sd_var        )
    lambda2_in <-             rnorm(1, lambda2_var       , lambda2_sd_var        )
    q_full_in <-              rnorm(1, q_full_var        , q_full_sd_var         )
    q_zero_in <-              rnorm(1, q_zero_var        , q_zero_sd_var         )
    delta_ed_in <-            rnorm(1, delta_ed_var      , delta_ed_sd_var * sd(delta_ed_vals[,1])) * delta_ed_vals[,1] 
    delta_ed_ext_in <-        rnorm(1, delta_ed_ext_var  , delta_ed_ext_sd_var * sd(delta_ed_ext_vals[,1])) * delta_ed_ext_vals[,1] 
    #############
    ##### Guess work    
    ############# 
    periods_in <-            rnorm(1, periods_var        , periods_sd_var     )
    time_to_jm_in <-         rnorm(1, time_to_jm_var     , time_to_sd_var     )
    coef_exp_in <-           rnorm(2, coef_exp_var       , coef_exp_sd_var    )
    teach_sal_in <-          rnorm(1, teach_sal_var      , teach_sal_sd_var   )
    teach_ben_in <-          rnorm(1, teach_ben_var      , teach_ben_sd_var   )
    n_students_in <-         rnorm(1, n_students_var     , n_students_sd_var  )
    #############
    
    
    return( sapply( ls(pattern= "_in"), function(x) get(x)) ) 
    }
#asd <- one_draw()
# Takes each element of list and assings it an object with the same name
#list2env(asd,.GlobalEnv)
# compute the elements of the model
#  input: K vectors with draws from sims
#  output: Input vectors for NPV function

one_draw_val <- one_draw()
elements <- function(inputs = one_draw_val) {
    list2env(inputs,.GlobalEnv)
    # 1 - "r""
    interest_r_var <- interest_var_comp(gov_bonds_in, inflation_in)
    return(interest_r_var)
}   
elements()

if (FALSE) {
  # - Model
  npv_sim <- rep(NA, nsims)
  #yes externality NPV
    # 1 - "r""
    interst_r_val <- gov_bonds_sim[i] - inflation_sim[i]
    interest_r_var <- interest_var_comp(gov_bonds_in, inflation_in)
    # 2 - "w_t"
    wage_0_val <- wage_0_f(wage_ag = wage_ag_val_sim[i],
                           wage_ww = wage_ww_val_sim[i],
                           profits_se = profits_se_val_sim[i],
                           hours_se_cond = hours_se_cond_val_sim[i],
                           hours_ag = hours_ag_val_sim[i],
                           hours_ww = hours_ww_val_sim[i],
                           hours_se = hours_se_val_sim[i],
                           ex_rate = ex_rate_val_sim[i])  
    experience_val <- 0:periods_val - time_to_jm_val
    wage_t_val <- wage_t(wage_0 = wage_0_val,
                         growth_rate = growth_rate_val_sim[i],
                         experience = experience_val,
                         coef_exp1 = coef_exp_val_sim[i,1],
                         coef_exp2 = coef_exp_val_sim[i,2])
    # 3 - “λ1,γ” and “λ2,γ”
    lambda1_vals_aux <- rep(0.5 * lambda1_vals_sim[i,1] + 0.5 * lambda1_vals_sim[i,2], 2)
    lambda2_vals <- rep(lambda2_val_sim[i], 2)
    # 4 - R and p
    #coverage_val_aux <-  saturation_val_sim[i] / full_saturation_val_sim[i]
    #saturation_val_aux <- full_saturation_val_sim[i] * coverage_val_sim[i]
    # 5 - K and ΔE⎯⎯⎯⎯γt(S1,S2)
    cost_per_student <- (teach_sal_val_sim[i] + teach_ben_val_sim[i]) / n_students_val_sim[i]
    delta_ed_ext_total_sim <- delta_ed_vals_sim[i,] + delta_ed_ext_vals_sim[i,]
    if (include_ext_vari==TRUE){
      delta_ed_final <-  delta_ed_ext_total_sim
    }else{
      delta_ed_final <- delta_ed_vals_sim[i,]
    }

    #6 - (S2Q(S2)−S1Q(S1))
    q2_val_aux <- q_full_val_sim[i]
    s2_val_aux <- ( unit_cost_local_val_sim[i] / ex_rate_val_sim[i] ) * years_of_treat_val_sim[i]
 
}
  


    ```

# Sensitivity Analysis  
